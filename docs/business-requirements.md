# Бизнес-требования

> Последнее обновление: 2026-02-15
> Статус: MVP в разработке

## Общее описание продукта

Медицинская экспертная система для автоматической интерпретации лабораторных анализов.
Клиент загружает PDF с анализами → система определяет вероятные причины отклонений → выдаёт результат в понятном виде.

## MVP версия

### Scope MVP:
- **Один вид анализов:** Общий анализ крови (ОАК)
- **Формат входа:** только оригинальные PDF (не сканы, не картинки)
- **Из шапки PDF:** только **имя пациента** и **пол**
- **Из таблицы PDF:** название параметра, результат, единица измерения
- **Референсные значения из PDF — ИГНОРИРУЕМ** (свои в БД)
- **Различие референсов:** только по полу (без возраста, без состояний)
- **Конвертация единиц:** если пришла не базовая единица — конвертируем по коэффициенту
- **Символы ▲ и ▼ в PDF — обрезаем** (сами определяем HIGH/LOW)

### Фронтенд MVP:
- Сайт на Tilda (делает другой человек, не наша зона ответственности)
- Кнопка "Загрузить анализ" (только PDF)
- Подпись: "Загрузите оригинальный PDF, не конвертированные изображения"

### Фронтенд будущее:
- Дополнительные поля ввода (чекбоксы, текстовые поля) для уточнения информации пациентом
- Поддержка изображений/сканов через OCR

## Полная версия (будущее)

### Расширения:
- Все виды анализов: биохимия, анализ мочи, гормоны и т.д.
- Разделение анализов по видам (система определяет тип автоматически)
- Учёт возраста пациента в референсах
- Учёт состояний (беременность, диабет и т.д.) через таблицы conditions
- OCR для сканированных PDF (Lab4U и подобные)
- Telegram бот
- Web-интерфейс для просмотра результатов
- История анализов, тренды
- Интеграция с N8N для оркестрации

## User Flow (MVP)

```
1. Клиент заходит на сайт (Tilda)
2. Нажимает "Загрузить анализ"
3. Загружает PDF файл
4. Система парсит PDF → извлекает данные
5. Нормализует через БД (analyte_aliases, unit конвертация)
6. Сравнивает с референсами (reference_ranges, по полу)
7. Определяет HIGH/LOW (формула ±5%)
8. Находит причины (analyte_cause_rules → causes)
9. Суммирует веса одинаковых причин
10. Формирует JSON с причинами
11. JSON обрабатывается (AI-агент?) для красивого вывода
12. Клиент получает результат:
    - Название причины (causes.name_ru)
    - Описание причины (causes.description)
    - Список повышенных/пониженных показателей
```

## Конечный вывод клиенту (пример)

```
⚠️ Нарушение функции печени
   Описание: [что это такое, что делать, к кому обратиться]
   Повышенные/пониженные показатели:
     - Холестерин: повышен
     - Белок: понижен

⚠️ Воспаление
   Описание: [...]
   Показатели:
     - Гемоглобин: повышен
     - Холестерин: повышен
```

Сортировка по суммарному весу и/или severity_level из таблицы causes.

## Формула сравнения с референсом

Сравнение НЕ строгое, с допуском ±5% на границах:

```
effective_max = ref_max + (ref_max × 0.05)
effective_min = ref_min - (ref_min × 0.05)

Если значение > effective_max → HIGH
Если значение < effective_min → LOW
Иначе → NORMAL
```

## Логика суммирования весов

```
Для каждого показателя с отклонением (HIGH/LOW):
  → Ищем в analyte_cause_rules (analyte_id + direction)
  → Получаем список причин с весами

Суммируем веса одинаковых причин по всем показателям:
  Пример:
    Гемоглобин HIGH → Воспаление (0.6)
    Холестерин HIGH → Воспаление (0.5), Печень (0.8)
    Белок LOW      → Воспаление (0.3), Печень (0.4)
    ИТОГО: Воспаление = 1.4, Печень = 1.2
```

## Историческое примечание

До 2026-02-15 планировалось:
- Извлекать возраст и состояния из PDF
- Использовать таблицы conditions и reference_range_conditions
- Хранить разные единицы измерения в reference_ranges

Решение об упрощении принято 2026-02-14 после обсуждения с командой.
Причина: большинство PDF не содержат полезных состояний, только имя и пол.
